<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bit.motrip.dao.chatroom.ChatRoomDao">
	<resultMap id="chatRoomResultMap" type="com.bit.motrip.domain.ChatRoom">
		<id column="chat_room_no" property="chatRoomNo" jdbcType="INTEGER"/>
		<result column="chat_room_title" property="chatRoomTitle" jdbcType="VARCHAR"/>
		<result column="travel_start_date" property="travelStartDate" jdbcType="DATE" javaType="java.util.Date" />
		<result column="age_range" property="ageRange" jdbcType="VARCHAR" />
		<result column="max_persons" property="maxPersons" jdbcType="INTEGER"/>
		<result column="current_persons" property="currentPersons" jdbcType="INTEGER"/>
		<result column="chat_room_status" property="chatRoomStatus" jdbcType="INTEGER"/>
		<result column="trip_plan_no" property="tripPlanNo" jdbcType="INTEGER"/>
	</resultMap>

	<resultMap id="chatMemberResultMap" type="com.bit.motrip.domain.ChatMember">
		<id column="member_no" property="memberNo" jdbcType="INTEGER"/>
		<result column="chat_room_no" property="chatRoomNo" jdbcType="INTEGER"/>
		<result column="user_id" property="userId" jdbcType="VARCHAR" />
		<result column="trip_plan_no" property="tripPlanNo" jdbcType="INTEGER"/>
		<result column="is_chat_room_author" property="isChatRoomAuthor" jdbcType="TINYINT"/>
	</resultMap>




	<insert id="addChatRoom" parameterType="com.bit.motrip.domain.ChatRoom">
		<selectKey keyProperty="chatRoomNo" resultType="int" order="AFTER">
			select last_insert_id()
		</selectKey>
		insert into chat_rooms (chat_room_title, travel_start_date, age_range, max_persons, current_persons)
		values (#{chatRoomTitle}, #{travelStartDate}, #{ageRange}, #{maxPersons}, #{currentPersons})
	</insert>

		<select id="getChatRoom" parameterType="int" resultMap="chatRoomResultMap">
			SELECT
				cr.chat_room_no,
				cr.chat_room_title,
				cr.travel_start_date,
				cr.age_range,
				cr.max_persons,
				cr.current_persons,
				cr.chat_room_status,
				cm.trip_plan_no,
				cm.user_id
			FROM chat_rooms cr
					 LEFT JOIN chat_room_members cm ON cr.chat_room_no = cm.chat_room_no
			where cm.chat_room_no = #{chatRoomNo} and is_chat_room_author = 1
		</select>

	<update id="updateChatRoom" parameterType="com.bit.motrip.domain.ChatRoom">
		update chat_rooms
		set
			chat_room_title = #{chatRoomTitle},
			travel_start_date = #{travelStartDate},
			age_range = #{ageRange},
			max_persons = #{maxPersons},
			current_persons = #{currentPersons}
		where
			chat_room_no = #{chatRoomNo}
	</update>

	<delete id="deleteChatRoom" parameterType="com.bit.motrip.domain.ChatRoom">
		DELETE FROM chat_rooms
		WHERE chat_room_no = #{chatRoomNo}
	</delete>
	
	<update id="changeRoomStatus" parameterType="Map">
		update chat_rooms
		set
		    chat_room_status = #{chatRoomStatus}
		where
			chat_room_no = #{chatRoomNo}
	</update>

	<select id="chatRoomList" resultMap="chatRoomResultMap">
		SELECT
			*
		FROM
			chat_rooms cr
			RIGHT JOIN (select chat_room_no,trip_plan_no from chat_room_members group by chat_room_no, trip_plan_no) crm
			    on cr.chat_room_no = crm.chat_room_no order by cr.chat_room_no
	</select>

	<select id="chatRoomListPage" resultMap="chatRoomResultMap">
		SELECT
			*
		FROM
			chat_rooms cr
				RIGHT JOIN (select chat_room_no,trip_plan_no from chat_room_members group by chat_room_no, trip_plan_no) crm
						   on cr.chat_room_no = crm.chat_room_no order by cr.chat_room_no
		LIMIT 4;
	</select>
</mapper>